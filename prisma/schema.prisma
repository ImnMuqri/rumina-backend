generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserTier {
  FREE
  PRO
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  EXPIRED
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum GoalStatus {
  ON_TRACK
  BEHIND
  COMPLETED
}

enum FinancialDiaryMood {
  PROUD
  REFLECTIVE
  ACCOMPLISHED
  GRATEFUL
  NEUTRAL
}

// User model
model User {
  id             Int              @id @default(autoincrement())
  email          String           @unique
  name           String?
  passwordHash   String
  tier           UserTier         @default(FREE)
  proExpiry      DateTime?        // optional for PRO yearly
  createdAt      DateTime         @default(now())

  // Relationships
  transactions   Transaction[]
  goals          Goal[]
  financialDiary FinancialDiary[]
  aiInsights     AiInsight[]
  subscriptions  Subscription[]
  payments       Payment[]

  @@index([email])
}

// Subscription model (for yearly PRO)
model Subscription {
  id              Int                @id @default(autoincrement())
  userId          Int
  plan            String             // e.g., "PRO_YEARLY"
  status          SubscriptionStatus
  startDate       DateTime           @default(now())
  currentPeriodEnd DateTime
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  user            User               @relation(fields: [userId], references: [id])

  @@unique([userId, plan])
  @@index([userId])
}

// Payment model (works with any gateway)
model Payment {
  id              Int      @id @default(autoincrement())
  userId          Int
  gatewayPaymentId String   // e.g., SenangPay payment ID
  amount          Float
  currency        String   @default("MYR")
  status          String   // e.g., "success", "failed", "pending"
  paymentMethod   String?  // card, wallet, etc.
  plan            String?  // optional, link to subscription/plan
  createdAt       DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

// Transaction model
model Transaction {
  id          Int            @id @default(autoincrement())
  user        User           @relation(fields: [userId], references: [id])
  userId      Int            @index
  type        TransactionType
  category    String
  amount      Float
  description String?
  date        DateTime       @default(now())
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

// Goal model
model Goal {
  id             Int       @id @default(autoincrement())
  user           User      @relation(fields: [userId], references: [id])
  userId         Int       @index
  title          String
  category       String
  targetAmount   Float
  savedAmount    Float     @default(0)
  targetDate     DateTime
  status         GoalStatus
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

// FinancialDiary model
model FinancialDiary {
  id           Int                 @id @default(autoincrement())
  user         User                @relation(fields: [userId], references: [id])
  userId       Int                 @index
  date         DateTime            @default(now())
  mood         FinancialDiaryMood
  content      Text
  summary      String?             // optional for dashboard
  aiInsight    String?             // Rumia’s reflection
  tags         String?             // comma-separated tags
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
}

// AiInsight model
model AiInsight {
  id                   Int       @id @default(autoincrement())
  user                 User      @relation(fields: [userId], references: [id])
  userId               Int       @index
  date                 DateTime  @default(now())
  wellnessScore        Int?      // nullable, 0–100
  savingsRate          Int?
  debtManagement       String?   // text-based insight
  emergencyFund        String?
  expenseControl       String?
  summary              String?   // optional AI summary
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
}
